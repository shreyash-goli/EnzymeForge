Bootstrap: docker
From: nvcr.io/nvidia/cuda:11.6.2-cudnn8-runtime-ubuntu20.04

%labels
    Maintainer EnzymeForge
    Description RFdiffusion for enzyme design
    Version 1.0

%environment
    export DEBIAN_FRONTEND=noninteractive
    export DGLBACKEND=pytorch
    export PYTHONUNBUFFERED=1
    export PATH=/opt/RFdiffusion:$PATH

%post
    # Update and install system dependencies
    apt-get update && apt-get install -y --no-install-recommends \
        wget \
        ca-certificates \
        git \
        build-essential \
        curl \
        aria2 \
        python3.9 \
        python3.9-dev \
        python3-pip \
        unzip

    # Upgrade pip
    python3.9 -m pip install -q -U --no-cache-dir pip setuptools wheel

    # Install PyTorch and DGL
    pip install -q --no-cache-dir \
        torch==1.12.1+cu116 --extra-index-url https://download.pytorch.org/whl/cu116 \
        dgl==1.0.2+cu116 -f https://data.dgl.ai/wheels/cu116/repo.html

    # Clone RFdiffusion
    cd /opt
    git clone https://github.com/RosettaCommons/RFdiffusion.git

    # Install RFdiffusion dependencies
    pip install -q --no-cache-dir \
        e3nn==0.3.3 \
        wandb==0.12.0 \
        pynvml==11.0.0 \
        decorator==5.1.0 \
        hydra-core==1.3.2 \
        pyrsistent==0.19.3 \
        icecream==2.1.3 \
        PyYAML==6.0.1 \
        numpy==1.26.4 \
        git+https://github.com/NVIDIA/dllogger#egg=dllogger \
        /opt/RFdiffusion/env/SE3Transformer

    # Install ColabDesign
    pip install -q --no-cache-dir git+https://github.com/sokrypton/ColabDesign.git

    # Cleanup
    apt-get autoremove -y
    apt-get clean
    rm -rf /var/lib/apt/lists/*

%runscript
    exec /bin/bash "$@"

%help
    RFdiffusion container for EnzymeForge enzyme design.

    Usage:
        singularity exec --nv rfdiffusion.sif python script.py

    Mount data:
        singularity exec --nv -B /data:/data rfdiffusion.sif python script.py
